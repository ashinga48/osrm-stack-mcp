version: '3.8'

services:
  osrm-backend:
    image: ghcr.io/project-osrm/osrm-backend:latest
    container_name: osrm-backend
    ports:
      - "${BACKEND_PORT:-5000}:5000"
    volumes:
      - osrm-data:/data
    command: osrm-routed --algorithm ${ALGORITHM:-mld} /data/${OSM_FILE:-berlin}.osrm
    restart: unless-stopped
    networks:
      - osrm-network

  osrm-frontend:
    image: osrm/osrm-frontend:latest
    container_name: osrm-frontend
    ports:
      - "${FRONTEND_PORT:-9966}:9966"
    environment:
      - OSRM_SERVER_URL=${OSRM_SERVER_URL:-http://osrm-backend:5000}
    depends_on:
      - osrm-backend
    restart: unless-stopped
    networks:
      - osrm-network

  osrm-proxy:
    build:
      context: ./osrm-proxy
    container_name: osrm-proxy
    ports:
      - "${PROXY_PORT:-5100}:5100"
    environment:
      - OSRM_GRAPH_BASENAME=${OSM_FILE:-berlin}
      - OSRM_ALGORITHM=${ALGORITHM:-mld}
      - OSRM_PORT=5000
      - PROXY_PORT=${PROXY_PORT:-5100}
    volumes:
      - osrm-data:/data
    restart: unless-stopped
      - osrm-network

  osrm-express:
    build:
      context: ./osrm-express
    container_name: osrm-express
    ports:
      - "5200:5200"
    environment:
      - OSRM_GRAPH_BASENAME=${OSM_FILE:-berlin}
      - OSRM_ALGORITHM=${ALGORITHM:-mld}
      - OSRM_PORT=5000
      - EXPRESS_PORT=5200
    volumes:
      - osrm-data:/data
    restart: unless-stopped
    networks:
      - osrm-network

  osrm-native:
    build:
      context: ./osrm-native
    platform: linux/amd64
    container_name: osrm-native
    ports:
      - "5300:5300"
    environment:
      - OSRM_GRAPH_BASENAME=${OSM_FILE:-berlin}
      - OSRM_ALGORITHM=${ALGORITHM:-MLD}
      - OSRM_PORT=5300
    volumes:
      - osrm-data:/data
    restart: unless-stopped
    networks:
      - osrm-network

volumes:
  osrm-data:
    driver: local

networks:
  osrm-network:
    driver: bridge

